name: Windows Build

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2
      
      - name: Install Scoop
        run: |
          Set-ExecutionPolicy RemoteSigned -Scope CurrentUser; 
          iex (new-object net.webclient).downloadstring('https://get.scoop.sh')

      - name: Add Scoop to PATH
        run: |
          $Env:Path += ";$Env:USERPROFILE\scoop\shims"
          echo "Scoop added to PATH"

      - name: Install Make and GCC
        run: |
          scoop install make
          scoop bucket add main
          scoop install gcc

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Build BELLE
        run: |
          cd belle
          cargo build --release

      - name: Run clippy on BELLE
        run: |
          cd belle
          cargo clippy -- -D warnings || (echo "::warning Clippy found warnings, but continuing." && exit 0)

      - name: Build the BELLE-assembler
        run: |
          cd basm
          cargo build --release

      - name: Run clippy on basm
        run: |
          cd basm
          cargo clippy -- -D warnings || (echo "::warning Clippy found warnings, but continuing." && exit 0)

      - name: Build the BELLE-disassembler
        run: |
          cd bdump
          make
